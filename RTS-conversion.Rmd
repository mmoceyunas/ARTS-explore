---
title: "RTS-conversion"
output: html_document
date: "2024-07-30"
---

#this is example code for how to convert the format of an RTS dataset into the proper form to be merged into the ARTS dataset. 
```{r}
#load packages
library(dplyr)
library(sf)
library(tidyverse)
library(sp)

#import the data, Replace this file directory with wherever your shapefile is exported to
M_positives = read_sf("Margo_positives/MoceyunasRTS.shp")
M_negatives = read_sf("Margo_negatives/ARTS_grid_subset selection.shp")

#explore the dataset format
names(M_positives)
head(M_positives)
names(M_negatives)

#example subset code
M_positives = subset(M_positives, Notes != "Further_review" | is.na(Notes)) #! = not
M_negatives = subset(M_negatives, TrainClass == "Negative")

#remove any layers that do not contain any information that we need.
M_positives=M_positives %>% dplyr::select(-c(Confidence, Notes, Shape_Leng, Shape_Area))
M_positives=M_positives %>% dplyr::select(-c(OBJECTID_1))
M_negatives=M_negatives %>% dplyr::select(-c(CreatorLab, grid_id, RTSCount, rts_suscep, id, large_grid, Shape_Leng, Shape_Area))


#create a new column for creator lab
M_positives$CretrLb = "MMoceyunas, Woodwell Climate Research Center" #not sure if this should be Margo or Yili.... Ask at next meeting? 
M_negatives$CretrLb = "MMoceyunas, Woodwell Climate Research Center"

#create a new column for the Train class. Positive means there are RTS present and Negative means there are no RTS present. 
M_positives$TrnClss = "Positive"

#create a new column for Label type which is polygon in this case
M_positives$LablTyp = "Polygon"

#create a new column for Notes that is blank. If you have a column with notes to include, rename it in the next line of code
M_positives$Notes = NA
M_negatives$Notes = NA

#rename any files so they are the correct names. Examples of the correct names are listed in the next line of code. The shapefile names need to be abbreviated.
#the format for this code is rename(new_name = old_name, new_name = old_name)
M_positives=M_positives %>% dplyr::rename(ReginNm = RegionName, BasMpDt = BaseMapDat, BsMpSrc = BaseMapSou, BsMpRsl = BaseMapRes)
M_negatives=M_negatives %>% dplyr::rename(ReginNm = RegionName, CntrdLt = CentroidLa, CntrdLn = CentroidLo, BasMpDt = BaseMapDat, BsMpSrc = BaseMapSou, BsMpRsl = BaseMapRes, TrnClss = TrainClass, LablTyp = LabelType)


#not actually necessary but I like to reorder my columns so everything looks the same. (the geometry column is where the spatial information is stored and does not need any changing)
#if you don't have a Centroid latitude (CntrdLt) and Centroid longitude(CntrdLn) column, thats ok, the dataformatting.R code can create it for you by using calculate_centroids = TRUE (and remove CntrdLt and CntrdLn from the below line of code)
M_positives=M_positives %>% dplyr::select(ReginNm, CretrLb, BasMpDt, BsMpSrc, BsMpRsl, TrnClss, LablTyp, Notes, geometry) 
M_negatives=M_negatives %>% dplyr::select(CntrdLt, CntrdLn, ReginNm, CretrLb, BasMpDt, BsMpSrc, BsMpRsl, TrnClss, LablTyp, Notes, geometry) 

#make sure the data is in the correct coordinate system
st_crs(M_positives)
M_negatives = st_transform(M_negatives, 3413)

#fix date range
M_negatives <- M_negatives %>%
  mutate(BasMpDt = if_else(!is.na(BasMpDt), 
                           paste(BasMpDt, BasMpDt, sep = ","), 
                           BasMpDt))
M_positives <- M_positives %>%
  mutate(BasMpDt = if_else(!is.na(BasMpDt), 
                           paste(BasMpDt, BasMpDt, sep = ","), 
                           BasMpDt))

#Add notes for NA
M_negatives <- M_negatives %>%
  mutate(Notes = ifelse(is.na(BasMpDt), 
                        "Earthstar Geographics does not have dates of base maps.", 
                        Notes))

M_negatives_test = subset(M_negatives, BasMpDt != "NULL")

#make numeric
M_positives <- M_positives %>%
  mutate(BsMpRsl = as.numeric(BsMpRsl))
M_negatives_test <- M_negatives_test %>%
  mutate(BsMpRsl = as.numeric(BsMpRsl))

#export the properly formatted shapefile
sf::st_write(M_negatives, "Margo_negatives/M_negatives_output.shp", overwrite = T,append =F)
sf::st_write(M_negatives_test, "Margo_negatives/M_negatives_test_output.shp", overwrite = T,append =F)

sf::st_write(M_positives, "Margo_positives/M_positives_output.shp", overwrite = T,append =F)



```

#Now you can use this formatted shapefile to import into dataformatting.R. This code will merge the new RTS dataset with ARTS. 
#https://github.com/whrc/ARTS/tree/main
#Ask Jackie or Heidi for more help if you have trouble reformatting or setting up the dataformatting.R document!